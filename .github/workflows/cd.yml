name: CD

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Make .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
        shell: bash

      - name: Debug - check .env exists
        run: |
          echo "[Build job] ls -al:"
          ls -al
          echo "--- .env preview ---"
          cat .env || echo "No .env found"

      - name: Archive .env and docker-compose.yml
        run: |
          mkdir deploy
          mv .env deploy/
          cp docker-compose.yml deploy/
          cp redis.conf deploy/       # Redis 설정 파일 포함
          cp -r monitoring deploy/    # 모니터링 설정 파일 포함
          tar -czvf deploy.tar.gz -C deploy .
        shell: bash

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-files
          path: deploy.tar.gz

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download deployment files
        uses: actions/download-artifact@v5
        with:
          name: deployment-files
          path: .

      - name: Debug - list files
        run: ls -al

      - name: Extract deployment files
        run: |
          echo "=== Extracting tar.gz ==="
          tar -xzvf deploy.tar.gz
          echo "=== After extraction ==="
          ls -al

      - name: Copy docker-compose.yml to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "docker-compose.yml"
          target: "/home/ubuntu/troublog/"

      - name: Copy .env to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: ".env"
          target: "/home/ubuntu/troublog/"

      - name: Copy monitoring configs to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "monitoring"
          target: "/home/ubuntu/troublog/"

      - name: Copy redis.conf to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "redis.conf"
          target: "/home/ubuntu/troublog/"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            cd /home/ubuntu/troublog

            # logs 디렉토리 생성 (없는 경우)
            mkdir -p logs

            # Docker 로그인
            sudo docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

            # 기존 컨테이너 종료
            sudo docker-compose down || true

            # 새 이미지 받기
            sudo docker-compose pull

            # 모니터링 포함하여 전체 스택 재실행
            sudo docker-compose up -d

            # 안 쓰는 이미지 정리
            sudo docker image prune -f

            # 컨테이너 상태 확인
            sudo docker-compose ps